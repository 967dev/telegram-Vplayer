<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Music Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary-color-rgb: 139, 92, 246;
            --secondary-color-rgb: 219, 39, 119;
            /* Telegram Safe Area Variables */
            --tg-safe-area-top: env(safe-area-inset-top, 0px);
            --tg-safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
            background-color: #000;
            overscroll-behavior: none;
        }
        #app {
            height: 100%;
            padding-top: var(--tg-safe-area-top);
        }
        footer#player {
            padding-bottom: calc(0.75rem + var(--tg-safe-area-bottom)); /* 0.75rem is p-3 */
        }
        input[type=range] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 5px; background: rgba(255,255,255,0.2);
            border-radius: 5px; outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 16px; height: 16px; background: #f3f4f6;
            cursor: pointer; border-radius: 50%;
        }
        #image-bg {
            position: fixed; top: -5%; left: -5%;
            width: 110%; height: 110%;
            z-index: 1;
            background-size: cover; background-position: center center;
            filter: blur(4px);
            transition: transform 0.2s ease-out, background-image 0.5s ease, filter 0.5s ease-in-out;
            background-color: #000;
        }
        #app::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2;
        }
        #visualizerCanvas {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 3; pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .marquee-wrapper {
            white-space: nowrap; overflow: hidden; width: 100%;
        }
        .is-scrolling .marquee-text {
            display: inline-block; padding-left: 100%;
            animation: marquee 12s linear infinite;
        }
        @keyframes marquee {
            0%   { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        main {
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 80px, black calc(100% - 80px), transparent 100%);
            mask-image: linear-gradient(to bottom, transparent 0%, black 80px, black calc(100% - 80px), transparent 100%);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .accent-bg {
            background-color: rgb(var(--primary-color-rgb));
            transition: background-color 0.5s ease;
        }
        .accent-bg:hover {
            background-color: rgb(var(--primary-color-rgb)) !important;
            filter: brightness(1.2);
        }
        .accent-bg-lite {
            background-color: rgba(var(--primary-color-rgb), 0.3);
            border-color: rgba(var(--primary-color-rgb), 0.5);
        }
        .accent-bg-lite-paused {
            background-color: rgba(var(--primary-color-rgb), 0.2);
            border-color: rgba(var(--primary-color-rgb), 0.4);
        }
        
        /* Styles for collapsed state */
        body.playlist-collapsed main#playlistContainer {
            transform: translateX(-100%);
            opacity: 0;
            pointer-events: none;
        }
        body.playlist-collapsed main#radioContainer {
            transform: translateX(100%);
            opacity: 0;
            pointer-events: none;
        }
        body.playlist-collapsed #image-bg {
            filter: blur(0px);
        }
    </style>
</head>
<body class="text-white antialiased">

    <div id="image-bg"></div>
    <div id="app" class="relative flex flex-col max-w-md mx-auto bg-transparent shadow-2xl overflow-hidden">
        <canvas id="visualizerCanvas"></canvas>
        <header class="relative p-4 bg-transparent z-10 text-center">
            <div class="flex justify-center items-center gap-2 mb-4">
                <button id="modePlaylistBtn" class="accent-bg text-white font-bold py-2 px-5 rounded-full transition-colors">My Music</button>
                <button id="modeRadioBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-5 rounded-full transition-colors">Radio</button>
            </div>
            <div class="flex justify-center items-center gap-2">
                <button id="togglePlaylistBtn" title="Toggle Playlist" class="accent-bg text-white font-bold py-3 px-4 rounded-full transition-colors flex-shrink-0">
                     <i class="fas fa-bars"></i>
                </button>
                <label for="audioUpload" class="accent-bg cursor-pointer text-white font-bold py-3 px-6 rounded-full transition-colors inline-flex items-center gap-2 shadow-lg">
                    <i class="fas fa-plus"></i>
                    <span>Add</span>
                </label>
                <input type="file" id="audioUpload" accept="audio/*" multiple class="hidden">
                 <button id="toggleEqBtn" title="Toggle Equalizer" class="accent-bg text-white font-bold py-3 px-4 rounded-full transition-colors flex-shrink-0">
                     <i class="fas fa-wave-square"></i>
                </button>
                 <button id="changeBgBtn" title="Change Background" class="accent-bg text-white font-bold py-3 px-4 rounded-full transition-colors flex-shrink-0">
                     <i class="fas fa-image"></i>
                </button>
            </div>
        </header>

        <main id="playlistContainer" class="relative flex-grow p-4 overflow-y-auto pb-40 z-10 space-y-2">
            <div id="initialMessage" class="flex flex-col items-center justify-center h-full text-gray-200 text-center">
                 <i class="fas fa-upload text-6xl mb-4"></i>
                 <p class="text-lg">Upload your music</p>
                 <p class="text-sm">Your playlist is empty</p>
            </div>
        </main>
        
        <main id="radioContainer" class="hidden relative flex-grow p-4 overflow-y-auto pb-40 z-10 space-y-2">
            <!-- Radio stations will be populated here -->
        </main>

        <footer id="player" class="relative fixed bottom-0 left-0 right-0 bg-black/30 backdrop-blur-xl border-t border-white/10 p-3 max-w-md mx-auto rounded-t-2xl transition-transform duration-300 translate-y-full z-20">
            <div class="flex items-center">
                <img id="currentTrackArt" src="https://placehold.co/64x64/1f2937/4b5563?text=Music" class="w-16 h-16 rounded-lg shadow-md mr-4 flex-shrink-0">
                <div class="flex-grow w-0 min-w-0">
                    <div id="currentTrackTitleWrapper" class="marquee-wrapper">
                         <p id="currentTrackTitle" class="font-bold marquee-text">Select a Track</p>
                    </div>
                    <p id="currentTrackArtist" class="text-sm text-gray-400 truncate">Nothing is playing</p>
                </div>
            </div>
            <div id="progressWrapper" class="flex items-center gap-2 text-xs text-gray-400 mt-3">
                <span id="currentTime">0:00</span>
                <input type="range" id="progressBar" value="0" max="100" class="flex-grow">
                <span id="totalTime">0:00</span>
            </div>
            <div class="flex items-center justify-center gap-6 mt-2">
                <button id="prevBtn" class="text-gray-300 hover:text-white transition-colors text-2xl"><i class="fas fa-backward-step"></i></button>
                <button id="playPauseBtn" class="accent-bg transition-colors w-16 h-16 rounded-full flex items-center justify-center text-3xl shadow-lg">
                    <i id="playIcon" class="fas fa-play"></i>
                    <i id="pauseIcon" class="fas fa-pause hidden"></i>
                </button>
                <button id="nextBtn" class="text-gray-300 hover:text-white transition-colors text-2xl"><i class="fas fa-forward-step"></i></button>
            </div>
            <div class="flex items-center gap-3 mt-4 px-6 pb-2">
                <i class="fas fa-volume-low text-gray-400"></i>
                <input type="range" id="volumeSlider" min="0" max="100" value="75" class="flex-grow">
                <i class="fas fa-volume-high text-gray-400"></i>
            </div>
            <audio id="audioPlayer" ></audio> <!-- crossOrigin removed, will be set by JS -->
        </footer>
    </div>
    
    <div id="bgModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-700 rounded-lg shadow-xl w-full max-w-sm max-h-full flex flex-col">
            <h2 class="text-lg font-bold p-4 border-b border-gray-700">Select Background</h2>
            <div class="p-4 border-b border-gray-700">
                <label for="bgUpload" class="w-full text-center cursor-pointer bg-green-600 hover:bg-green-500 p-2 rounded-lg transition-colors block">
                    <i class="fas fa-upload"></i> Upload from device
                </label>
                <input type="file" id="bgUpload" accept="image/*" class="hidden">
            </div>
            <div id="bgGrid" class="grid grid-cols-3 gap-2 p-4 overflow-y-auto"></div>
            <div class="p-4 border-t border-gray-700">
                 <button id="closeBgModal" class="w-full bg-red-600 hover:bg-red-500 p-2 rounded-lg transition-colors">Close</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const appContainer = document.getElementById('app');
        const imageBg = document.getElementById('image-bg');
        const canvas = document.getElementById('visualizerCanvas');
        const canvasCtx = canvas.getContext('2d');
        const audioUpload = document.getElementById('audioUpload');
        const playlistContainer = document.getElementById('playlistContainer');
        const radioContainer = document.getElementById('radioContainer');
        const player = document.getElementById('player');
        const currentTrackArt = document.getElementById('currentTrackArt');
        const currentTrackTitle = document.getElementById('currentTrackTitle');
        const currentTrackArtist = document.getElementById('currentTrackArtist');
        const audioPlayer = document.getElementById('audioPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const progressWrapper = document.getElementById('progressWrapper');
        const progressBar = document.getElementById('progressBar');
        const currentTime = document.getElementById('currentTime');
        const totalTime = document.getElementById('totalTime');
        const initialMessage = document.getElementById('initialMessage');
        const volumeSlider = document.getElementById('volumeSlider');
        const toggleEqBtn = document.getElementById('toggleEqBtn');
        const changeBgBtn = document.getElementById('changeBgBtn');
        const bgModal = document.getElementById('bgModal');
        const bgGrid = document.getElementById('bgGrid');
        const closeBgModal = document.getElementById('closeBgModal');
        const bgUpload = document.getElementById('bgUpload');
        const togglePlaylistBtn = document.getElementById('togglePlaylistBtn');
        const modePlaylistBtn = document.getElementById('modePlaylistBtn');
        const modeRadioBtn = document.getElementById('modeRadioBtn');

        // State & Visualizer
        let playlist = [], radioStations = [], currentRadioIndex = -1, currentIndex = -1, isPlaying = false, db;
        let audioContext, analyser, sourceNode, dataArray;
        let animationFrameId = null;
        let equalizerEnabled = true;
        let colorThief;
        let currentMode = 'playlist';

        audioPlayer.volume = 0.75;
        
        // --- BUILT-IN DATA ---
        const builtInBacks = [ 'back/1.png', 'back/11.jpg', 'back/12.jpg', 'back/13.jpg', 'back/14.jpg', 'back/36.jpg', 'back/37.jpg', 'back/9.jpg' ];
        const builtInRadioStations = [
            { name: "NRJ DnB", genre: "Drum & Bass", streamUrl: "https://edge04.cdn.bitflip.ee:8888/NRJdnb" },
            { name: "Lofi Radio", genre: "Chill / Lofi Hip-Hop", streamUrl: "https://boxradio-edge-00.streamafrica.net/lofi" },
            { name: "EDM Radio", genre: "Electronic Dance Music", streamUrl: "https://edmradio.stream.laut.fm/edmradio" },
            { name: "1000 Hiphop", genre: "Hip-Hop / Rap", streamUrl: "https://1000hiphop.stream.laut.fm/1000hiphop" },
            { name: "Like POP", genre: "Pop Hits", streamUrl: "https://likeradiostream.com/likepop" },
            { name: "Classic Rock", genre: "Rock Anthems", streamUrl: "https://live-bauerno.sharp-stream.com/simulcast3_no.mp3" }
        ];
        
        // --- LOGIC ---
        function setMode(mode) {
            currentMode = mode;
            localStorage.setItem('player_mode', mode);
            if (mode === 'playlist') {
                playlistContainer.classList.remove('hidden');
                radioContainer.classList.add('hidden');
                modePlaylistBtn.classList.add('accent-bg');
                modePlaylistBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                modeRadioBtn.classList.remove('accent-bg');
                modeRadioBtn.classList.add('bg-gray-700', 'hover:bg-gray-600');
            } else { // radio
                playlistContainer.classList.add('hidden');
                radioContainer.classList.remove('hidden');
                modeRadioBtn.classList.add('accent-bg');
                modeRadioBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                modePlaylistBtn.classList.remove('accent-bg');
                modePlaylistBtn.classList.add('bg-gray-700', 'hover:bg-gray-600');
            }
        }

        function displayRadioStations() {
            radioContainer.innerHTML = '';
            builtInRadioStations.forEach((station, index) => {
                const stationEl = document.createElement('div');
                stationEl.className = 'track-item flex items-center justify-between p-3 rounded-xl bg-black/20 backdrop-blur-lg border border-white/5 hover:bg-black/40 cursor-pointer transition-colors duration-200';
                stationEl.innerHTML = `
                    <div class="flex items-center flex-grow overflow-hidden mr-2 w-0 min-w-0">
                        <div class="w-12 h-12 rounded-md mr-4 bg-white/10 flex items-center justify-center flex-shrink-0">
                           <i class="fas fa-headphones text-gray-300 text-xl"></i>
                        </div>
                        <div class="flex-grow overflow-hidden w-0 min-w-0">
                            <p class="font-semibold truncate">${station.name}</p>
                            <p class="text-sm text-gray-400 truncate">${station.genre}</p>
                        </div>
                    </div>`;
                stationEl.addEventListener('click', () => playRadioStation(index));
                radioContainer.appendChild(stationEl);
            });
        }
        
        function playRadioStation(index) {
            if (index < 0 || index >= builtInRadioStations.length) return;
            audioPlayer.removeAttribute('crossOrigin');
            canvas.style.opacity = 0; 
            if (!audioContext) setupVisualizer();
            currentRadioIndex = index;
            const station = builtInRadioStations[index];
            audioPlayer.src = station.streamUrl;
            currentTrackTitle.textContent = station.name;
            currentTrackArtist.textContent = station.genre;
            currentTrackArt.src = "https://placehold.co/64x64/1f2937/4b5563?text=Radio";
            progressWrapper.classList.add('hidden');
            audioPlayer.play().then(() => {
                if (audioContext.state === 'suspended') audioContext.resume();
                setPlayingState(true);
                player.classList.remove('translate-y-full');
            }).catch(e => { console.error("Radio playback error:", e); setPlayingState(false); });
        }
        
        function playTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            audioPlayer.setAttribute('crossOrigin', 'anonymous');
            canvas.style.opacity = 1;
            if (!audioContext) setupVisualizer();
            currentIndex = index;
            const trackInfo = playlist[currentIndex];
            db.transaction('tracks').objectStore('tracks').get(trackInfo.id).onsuccess = (event) => {
                const fullTrack = event.target.result;
                const audioURL = URL.createObjectURL(fullTrack.file);
                if (audioPlayer.src.startsWith('blob:')) URL.revokeObjectURL(audioPlayer.src);
                audioPlayer.src = audioURL;
                currentTrackTitle.textContent = trackInfo.fileName;
                currentTrackArtist.textContent = "Local File";
                currentTrackArt.src = "https://placehold.co/64x64/1f2937/4b5563?text=Music";
                progressWrapper.classList.remove('hidden');
                setTimeout(() => applyMarqueeIfNeeded(currentTrackTitle), 100);
                audioPlayer.play().then(() => {
                    if (audioContext.state === 'suspended') audioContext.resume();
                    setPlayingState(true);
                    player.classList.remove('translate-y-full');
                }).catch(e => console.error("Playback error:", e));
            };
        }

        function togglePlayPause() {
            if(currentMode === 'playlist') {
                if (currentIndex === -1 && playlist.length > 0) return playTrack(0);
                if (currentIndex === -1) return;
            } else {
                if (currentRadioIndex === -1 && builtInRadioStations.length > 0) return playRadioStation(0);
                if (currentRadioIndex === -1) return;
            }
            const action = isPlaying ? 'pause' : 'play';
            if (audioContext && audioContext.state === 'suspended') {
                 audioContext.resume().then(() => audioPlayer[action]());
            } else {
                audioPlayer[action]();
            }
        }
        function playNext() {
            if (currentMode === 'playlist') {
                playTrack((currentIndex + 1) % playlist.length || 0);
            } else {
                playRadioStation((currentRadioIndex + 1) % builtInRadioStations.length || 0);
            }
        }
        function playPrev() {
            if (currentMode === 'playlist') {
                playTrack((currentIndex - 1 + playlist.length) % playlist.length || 0);
            } else {
                playRadioStation((currentRadioIndex - 1 + builtInRadioStations.length) % builtInRadioStations.length || 0);
            }
        }
        
        function updateAccentColor(imageUrl) { const tempImg = new Image(); tempImg.crossOrigin = "Anonymous"; tempImg.src = imageUrl; tempImg.onload = () => { try { const palette = colorThief.getPalette(tempImg, 3); let bestColor = palette[0]; let maxVibrancy = 0; palette.forEach(color => { const [r, g, b] = color; const avg = (r + g + b) / 3; const saturation = Math.sqrt(Math.pow(r - avg, 2) + Math.pow(g - avg, 2) + Math.pow(b - avg, 2)); const brightness = Math.max(r, g, b); const vibrancy = saturation + brightness; if (vibrancy > maxVibrancy && saturation > 30) { maxVibrancy = vibrancy; bestColor = color; } }); const primaryRgb = bestColor.join(', '); const secondaryRgb = (palette[1] || bestColor).join(', '); document.documentElement.style.setProperty('--primary-color-rgb', primaryRgb); document.documentElement.style.setProperty('--secondary-color-rgb', secondaryRgb); } catch (e) { console.error("ColorThief error:", e); document.documentElement.style.setProperty('--primary-color-rgb', '139, 92, 246'); document.documentElement.style.setProperty('--secondary-color-rgb', '219, 39, 119'); } }; tempImg.onerror = () => { document.documentElement.style.setProperty('--primary-color-rgb', '139, 92, 246'); document.documentElement.style.setProperty('--secondary-color-rgb', '219, 39, 119'); } }
        function loadBackgrounds() { bgGrid.innerHTML = ''; builtInBacks.forEach(url => { const imgContainer = document.createElement('div'); imgContainer.className = 'cursor-pointer aspect-square rounded-md overflow-hidden transition-transform hover:scale-105'; imgContainer.innerHTML = `<img src="${url}" class="w-full h-full object-cover" loading="lazy">`; imgContainer.onclick = () => selectBackground(url); bgGrid.appendChild(imgContainer); }); }
        function selectBackground(imageDataUrl) { localStorage.setItem('background_image', imageDataUrl); imageBg.style.backgroundImage = `url('${imageDataUrl}')`; updateAccentColor(imageDataUrl); bgModal.classList.add('hidden'); }
        function handleBgUpload(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => selectBackground(e.target.result); reader.readAsDataURL(file); }
        function loadSavedBackground() { const savedBg = localStorage.getItem('background_image'); if (savedBg) { imageBg.style.backgroundImage = `url('${savedBg}')`; updateAccentColor(savedBg); } else if (builtInBacks.length > 0) { const randomBg = builtInBacks[Math.floor(Math.random() * builtInBacks.length)]; imageBg.style.backgroundImage = `url('${randomBg}')`; updateAccentColor(randomBg); } else { imageBg.style.backgroundImage = 'none'; } }
        function animateVisualizer() { animationFrameId = requestAnimationFrame(animateVisualizer); if (!equalizerEnabled || !analyser) { if(canvasCtx) canvasCtx.clearRect(0, 0, canvas.width, canvas.height); return; } analyser.getByteFrequencyData(dataArray); canvasCtx.clearRect(0, 0, canvas.width, canvas.height); const isCollapsed = document.body.classList.contains('playlist-collapsed'); const primaryRgb = getComputedStyle(document.documentElement).getPropertyValue('--primary-color-rgb'); const waveCount = 3; const sliceWidth = canvas.width / dataArray.length; const baseline = isCollapsed ? canvas.height / 2 : canvas.height - (player.offsetHeight / 2) - 10; const amplitude = isCollapsed ? 150 : 80; for (let j = 0; j < waveCount; j++) { canvasCtx.beginPath(); canvasCtx.moveTo(0, baseline); canvasCtx.strokeStyle = `rgba(${primaryRgb}, ${0.8 - j * 0.2})`; canvasCtx.lineWidth = 3 - j; for (let i = 0; i < dataArray.length; i++) { const v = dataArray[i] / 255.0; const y = baseline - (v * amplitude * (1 - j * 0.2)); const x = i * sliceWidth; canvasCtx.lineTo(x, y); } canvasCtx.lineTo(canvas.width, baseline); canvasCtx.stroke(); } }
        function handleParallax(e) { const { innerWidth: width, innerHeight: height } = window; let x, y; let strength; if (e.gamma !== undefined && e.beta !== undefined) { strength = 30; x = (e.gamma + 90) * (width / 180); y = (e.beta + 90) * (height / 180); } else { strength = 15; x = e.clientX; y = e.clientY; } const xPercent = (x / width - 0.5) * 2; const yPercent = (y / height - 0.5) * 2; const offsetX = -xPercent * strength; const offsetY = -yPercent * strength; imageBg.style.transform = `translate(${offsetX}px, ${offsetY}px)`; }
        function setupVisualizer() { if (audioContext) return; try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); sourceNode = audioContext.createMediaElementSource(audioPlayer); analyser = audioContext.createAnalyser(); analyser.fftSize = 256; sourceNode.connect(analyser); analyser.connect(audioContext.destination); dataArray = new Uint8Array(analyser.frequencyBinCount); resizeCanvas(); animateVisualizer(); } catch (e) { console.error("Could not initialize Web Audio API.", e); } }
        function resizeCanvas() { canvas.width = appContainer.clientWidth; canvas.height = appContainer.clientHeight; applyMarqueeToAll(); }
        function toggleEqualizer() { equalizerEnabled = !equalizerEnabled; toggleEqBtn.classList.toggle('accent-bg'); toggleEqBtn.classList.toggle('bg-gray-600', !equalizerEnabled); if (!equalizerEnabled && canvasCtx) canvasCtx.clearRect(0, 0, canvas.width, canvas.height); }
        function initDB() { const request = indexedDB.open('musicPlayerDB_tg', 1); request.onerror = (event) => console.error("Database error:", event.target.errorCode); request.onupgradeneeded = (event) => { event.target.result.createObjectStore('tracks', { keyPath: 'id', autoIncrement: true }); }; request.onsuccess = (event) => { db = event.target.result; loadPlaylistFromDB(); }; }
        function saveTrackToDB(file) { const transaction = db.transaction(['tracks'], 'readwrite'); const store = transaction.objectStore('tracks'); const trackData = { file: file, fileName: file.name.replace(/\.[^/.]+$/, ""), artistName: "Local File" }; store.add(trackData).onsuccess = (event) => { const track = { ...trackData, id: event.target.result }; delete track.file; playlist.push(track); displayPlaylist(); }; }
        function loadPlaylistFromDB() { db.transaction('tracks').objectStore('tracks').getAll().onsuccess = (event) => { playlist = event.target.result.map(({id, fileName, artistName}) => ({id, fileName, artistName})); displayPlaylist(); }; }
        function deleteTrack(index) { if (index < 0 || index >= playlist.length) return; const trackId = playlist[index].id; const transaction = db.transaction(['tracks'], 'readwrite'); transaction.objectStore('tracks').delete(trackId).onsuccess = () => { if (index === currentIndex) { audioPlayer.pause(); audioPlayer.src = ''; player.classList.add('translate-y-full'); currentIndex = -1; setPlayingState(false); } else if (index < currentIndex) { currentIndex--; } playlist.splice(index, 1); displayPlaylist(); }; }
        function handleFiles(event) { Array.from(event.target.files).forEach(saveTrackToDB); audioUpload.value = null; }
        function applyMarqueeIfNeeded(textElement) { const wrapper = textElement.parentElement; if (!wrapper) return; const shouldScroll = textElement.scrollWidth > wrapper.clientWidth; wrapper.classList.toggle('is-scrolling', shouldScroll); }
        function applyMarqueeToAll() { if(currentTrackTitle) applyMarqueeIfNeeded(currentTrackTitle); playlistContainer.querySelectorAll('.marquee-text').forEach(applyMarqueeIfNeeded); }
        function displayPlaylist() { playlistContainer.innerHTML = ''; initialMessage.classList.toggle('hidden', playlist.length > 0); playlist.forEach((track, index) => { const trackElement = document.createElement('div'); trackElement.className = 'track-item flex items-center justify-between p-3 rounded-xl bg-black/20 backdrop-blur-lg border border-white/5 hover:bg-black/40 cursor-pointer transition-colors duration-200'; const trackInfoContainer = document.createElement('div'); trackInfoContainer.className = 'flex items-center flex-grow overflow-hidden mr-2 w-0 min-w-0'; trackInfoContainer.innerHTML = `<div class="w-12 h-12 rounded-md mr-4 bg-white/10 flex items-center justify-center flex-shrink-0"><i class="fas fa-music text-gray-300 text-xl"></i></div><div class="flex-grow overflow-hidden w-0 min-w-0"><div class="marquee-wrapper"><p class="marquee-text font-semibold">${track.fileName}</p></div><p class="text-sm text-gray-400 truncate">${track.artistName}</p></div>`; trackInfoContainer.addEventListener('click', () => playTrack(index)); const deleteButton = document.createElement('button'); deleteButton.className = 'delete-btn flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-gray-400 hover:bg-red-500/20 hover:text-red-400 transition-colors'; deleteButton.innerHTML = `<i class="fas fa-trash-alt"></i>`; deleteButton.addEventListener('click', (e) => { e.stopPropagation(); deleteTrack(index); }); trackElement.appendChild(trackInfoContainer); trackElement.appendChild(deleteButton); playlistContainer.appendChild(trackElement); applyMarqueeIfNeeded(trackElement.querySelector('.marquee-text')); }); updateActiveTrackUI(); }
        function setPlayingState(playing) { isPlaying = playing; playIcon.classList.toggle('hidden', isPlaying); pauseIcon.classList.toggle('hidden', !isPlaying); updateActiveTrackUI(); if (!audioContext) return; if (isPlaying && !animationFrameId) animateVisualizer(); else if (!isPlaying && animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; } }
        function updateActiveTrackUI() { playlistContainer.querySelectorAll('.track-item').forEach((el, index) => { const isCurrent = index === currentIndex; el.classList.remove('accent-bg-lite', 'accent-bg-lite-paused'); if (isCurrent && isPlaying) { el.classList.add('accent-bg-lite'); } else if (isCurrent && !isPlaying) { el.classList.add('accent-bg-lite-paused'); } }); radioContainer.querySelectorAll('.track-item').forEach((el, index) => { const isCurrent = index === currentRadioIndex; el.classList.remove('accent-bg-lite', 'accent-bg-lite-paused'); if (isCurrent && isPlaying) { el.classList.add('accent-bg-lite'); } else if (isCurrent && !isPlaying) { el.classList.add('accent-bg-lite-paused'); } }); }
        function updateProgress() { const { duration, currentTime: time } = audioPlayer; const progressPercent = (time / duration) * 100; progressBar.value = isNaN(progressPercent) ? 0 : progressPercent; currentTime.textContent = formatTime(time); totalTime.textContent = isNaN(duration) ? '0:00' : formatTime(duration); }
        function setProgress() { const duration = audioPlayer.duration; if (!isNaN(duration)) audioPlayer.currentTime = (progressBar.value * duration) / 100; }
        function setVolume() { audioPlayer.volume = volumeSlider.value / 100; }
        function formatTime(seconds) { const secs = Math.floor(seconds || 0); const minutes = Math.floor(secs / 60); const remainingSeconds = secs % 60; return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`; }
        
        window.addEventListener('DOMContentLoaded', () => {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            colorThief = new ColorThief();
            initDB();
            loadSavedBackground();
            displayRadioStations();
            const savedMode = localStorage.getItem('player_mode') || 'playlist';
            setMode(savedMode);
        });
        
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('mousemove', handleParallax);
        window.addEventListener('deviceorientation', handleParallax);
        audioUpload.addEventListener('change', handleFiles);
        toggleEqBtn.addEventListener('click', toggleEqualizer);
        togglePlaylistBtn.addEventListener('click', () => document.body.classList.toggle('playlist-collapsed'));
        changeBgBtn.addEventListener('click', () => { loadBackgrounds(); bgModal.classList.remove('hidden'); });
        closeBgModal.addEventListener('click', () => bgModal.classList.add('hidden'));
        bgUpload.addEventListener('change', handleBgUpload);
        modePlaylistBtn.addEventListener('click', () => setMode('playlist'));
        modeRadioBtn.addEventListener('click', () => setMode('radio'));
        playPauseBtn.addEventListener('click', togglePlayPause);
        nextBtn.addEventListener('click', playNext);
        prevBtn.addEventListener('click', playPrev);
        audioPlayer.addEventListener('timeupdate', updateProgress);
        audioPlayer.addEventListener('play', () => setPlayingState(true));
        audioPlayer.addEventListener('pause', () => setPlayingState(false));
        audioPlayer.addEventListener('ended', playNext);
        progressBar.addEventListener('input', setProgress);
        volumeSlider.addEventListener('input', setVolume);
    </script>
</body>
</html>

