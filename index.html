<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Music Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary-color-rgb: 139, 92, 246;
            --secondary-color-rgb: 219, 39, 119;
            --tg-safe-area-top: env(safe-area-inset-top, 0px);
            --tg-safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
            background-color: #000;
            overscroll-behavior: none;
        }
        #app {
            height: 100%;
            padding-top: var(--tg-safe-area-top);
        }
        footer#player {
            padding-bottom: calc(0.75rem + var(--tg-safe-area-bottom));
        }
        input[type=range] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 5px; background: rgba(255,255,255,0.2);
            border-radius: 5px; outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 16px; height: 16px; background: #f3f4f6;
            cursor: pointer; border-radius: 50%;
        }
        #image-bg {
            position: fixed; top: -5%; left: -5%;
            width: 110%; height: 110%;
            z-index: 1;
            background-size: cover; background-position: center center;
            filter: blur(4px);
            transition: transform 0.2s ease-out, background-image 0.5s ease, filter 0.5s ease-in-out;
            background-color: #000;
        }
        #app::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2;
        }
        #visualizerCanvas {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 3; pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .marquee-wrapper {
            white-space: nowrap; overflow: hidden; width: 100%;
        }
        .is-scrolling .marquee-text {
            display: inline-block; padding-left: 100%;
            animation: marquee 12s linear infinite;
        }
        @keyframes marquee {
            0%   { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        main {
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 80px, black calc(100% - 80px), transparent 100%);
            mask-image: linear-gradient(to bottom, transparent 0%, black 80px, black calc(100% - 80px), transparent 100%);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .accent-bg {
            background-color: rgb(var(--primary-color-rgb));
            transition: background-color 0.5s ease;
        }
        .accent-bg:hover {
            background-color: rgb(var(--primary-color-rgb)) !important;
            filter: brightness(1.2);
        }
        .accent-bg-lite {
            background-color: rgba(var(--primary-color-rgb), 0.3);
            border-color: rgba(var(--primary-color-rgb), 0.5);
        }
        .accent-bg-lite-paused {
            background-color: rgba(var(--primary-color-rgb), 0.2);
            border-color: rgba(var(--primary-color-rgb), 0.4);
        }
        
        /* Styles for collapsed state */
        body.playlist-collapsed main#playlistContainer {
            transform: translateX(-100%);
            opacity: 0;
            pointer-events: none;
        }
        body.playlist-collapsed main#radioContainer {
            transform: translateX(100%);
            opacity: 0;
            pointer-events: none;
        }
        body.playlist-collapsed #image-bg {
            filter: blur(0px);
        }
        
        /* Radio status indicator */
        .radio-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
        }
        .status-buffering {
            background-color: #f59e0b;
            animation: pulse 1.5s infinite;
        }
        .status-playing {
            background-color: #10b981;
        }
        .status-error {
            background-color: #ef4444;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Station editor */
        .station-editor {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="text-white antialiased">

    <div id="image-bg"></div>
    <div id="app" class="relative flex flex-col max-w-md mx-auto bg-transparent shadow-2xl overflow-hidden">
        <canvas id="visualizerCanvas"></canvas>
        <header class="relative p-4 bg-transparent z-10 text-center">
            <div class="flex justify-center items-center gap-2 mb-4">
                <button id="modePlaylistBtn" class="accent-bg text-white font-bold py-2 px-5 rounded-full transition-colors">My Music</button>
                <button id="modeRadioBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-5 rounded-full transition-colors">Radio</button>
            </div>
            <div class="flex justify-center items-center gap-2">
                <button id="togglePlaylistBtn" title="Toggle Playlist" class="accent-bg text-white font-bold py-3 px-4 rounded-full transition-colors flex-shrink-0">
                     <i class="fas fa-bars"></i>
                </button>
                <label for="audioUpload" class="accent-bg cursor-pointer text-white font-bold py-3 px-6 rounded-full transition-colors inline-flex items-center gap-2 shadow-lg">
                    <i class="fas fa-plus"></i>
                    <span>Add</span>
                </label>
                <input type="file" id="audioUpload" accept="audio/*" multiple class="hidden">
                 <button id="toggleEqBtn" title="Toggle Equalizer" class="accent-bg text-white font-bold py-3 px-4 rounded-full transition-colors flex-shrink-0">
                     <i class="fas fa-wave-square"></i>
                </button>
                 <button id="changeBgBtn" title="Change Background" class="accent-bg text-white font-bold py-3 px-4 rounded-full transition-colors flex-shrink-0">
                     <i class="fas fa-image"></i>
                </button>
            </div>
        </header>

        <main id="playlistContainer" class="relative flex-grow p-4 overflow-y-auto pb-40 z-10 space-y-2">
            <div id="initialMessage" class="flex flex-col items-center justify-center h-full text-gray-200 text-center">
                 <i class="fas fa-upload text-6xl mb-4"></i>
                 <p class="text-lg">Upload your music</p>
                 <p class="text-sm">Your playlist is empty</p>
            </div>
        </main>
        
        <main id="radioContainer" class="hidden relative flex-grow p-4 overflow-y-auto pb-40 z-10 space-y-2">
            <!-- Radio stations will be populated here -->
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">Radio Stations</h2>
                <button id="addStationBtn" class="bg-green-600 hover:bg-green-500 text-white py-1 px-3 rounded-full text-sm">
                    <i class="fas fa-plus mr-1"></i> Add
                </button>
            </div>
            <div id="stationsList"></div>
        </main>

        <footer id="player" class="relative fixed bottom-0 left-0 right-0 bg-black/30 backdrop-blur-xl border-t border-white/10 p-3 max-w-md mx-auto rounded-t-2xl transition-transform duration-300 translate-y-full z-20">
            <div class="flex items-center">
                <img id="currentTrackArt" src="https://placehold.co/64x64/1f2937/4b5563?text=Music" class="w-16 h-16 rounded-lg shadow-md mr-4 flex-shrink-0">
                <div class="flex-grow w-0 min-w-0">
                    <div id="currentTrackTitleWrapper" class="marquee-wrapper">
                         <p id="currentTrackTitle" class="font-bold marquee-text">Select a Track</p>
                         <span id="radioStatus" class="radio-status hidden"></span>
                    </div>
                    <p id="currentTrackArtist" class="text-sm text-gray-400 truncate">Nothing is playing</p>
                </div>
            </div>
            <div id="progressWrapper" class="flex items-center gap-2 text-xs text-gray-400 mt-3">
                <span id="currentTime">0:00</span>
                <input type="range" id="progressBar" value="0" max="100" class="flex-grow">
                <span id="totalTime">0:00</span>
            </div>
            <div class="flex items-center justify-center gap-6 mt-2">
                <button id="prevBtn" class="text-gray-300 hover:text-white transition-colors text-2xl"><i class="fas fa-backward-step"></i></button>
                <button id="playPauseBtn" class="accent-bg transition-colors w-16 h-16 rounded-full flex items-center justify-center text-3xl shadow-lg">
                    <i id="playIcon" class="fas fa-play"></i>
                    <i id="pauseIcon" class="fas fa-pause hidden"></i>
                </button>
                <button id="nextBtn" class="text-gray-300 hover:text-white transition-colors text-2xl"><i class="fas fa-forward-step"></i></button>
            </div>
            <div class="flex items-center gap-3 mt-4 px-6 pb-2">
                <i class="fas fa-volume-low text-gray-400"></i>
                <input type="range" id="volumeSlider" min="0" max="100" value="75" class="flex-grow">
                <i class="fas fa-volume-high text-gray-400"></i>
            </div>
            <audio id="audioPlayer" ></audio>
        </footer>
    </div>
    
    <div id="bgModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-700 rounded-lg shadow-xl w-full max-w-sm max-h-full flex flex-col">
            <h2 class="text-lg font-bold p-4 border-b border-gray-700">Select Background</h2>
            <div class="p-4 border-b border-gray-700">
                <label for="bgUpload" class="w-full text-center cursor-pointer bg-green-600 hover:bg-green-500 p-2 rounded-lg transition-colors block">
                    <i class="fas fa-upload"></i> Upload from device
                </label>
                <input type="file" id="bgUpload" accept="image/*" class="hidden">
            </div>
            <div id="bgGrid" class="grid grid-cols-3 gap-2 p-4 overflow-y-auto"></div>
            <div class="p-4 border-t border-gray-700">
                 <button id="closeBgModal" class="w-full bg-red-600 hover:bg-red-500 p-2 rounded-lg transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Station Editor Modal -->
    <div id="stationModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-700 rounded-lg shadow-xl w-full max-w-sm max-h-full flex flex-col station-editor">
            <h2 class="text-lg font-bold p-4 border-b border-gray-700" id="stationModalTitle">Add Radio Station</h2>
            <div class="p-4 space-y-3">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Station Name</label>
                    <input type="text" id="stationName" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Genre</label>
                    <input type="text" id="stationGenre" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Stream URL</label>
                    <input type="text" id="stationUrl" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="https://">
                </div>
            </div>
            <div class="p-4 border-t border-gray-700 flex justify-between">
                <button id="testStationBtn" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg transition-colors">Test</button>
                <div class="space-x-2">
                    <button id="cancelStationBtn" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded-lg transition-colors">Cancel</button>
                    <button id="saveStationBtn" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg transition-colors">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const appContainer = document.getElementById('app');
        const imageBg = document.getElementById('image-bg');
        const canvas = document.getElementById('visualizerCanvas');
        const canvasCtx = canvas.getContext('2d');
        const audioUpload = document.getElementById('audioUpload');
        const playlistContainer = document.getElementById('playlistContainer');
        const radioContainer = document.getElementById('radioContainer');
        const player = document.getElementById('player');
        const currentTrackArt = document.getElementById('currentTrackArt');
        const currentTrackTitle = document.getElementById('currentTrackTitle');
        const currentTrackArtist = document.getElementById('currentTrackArtist');
        const audioPlayer = document.getElementById('audioPlayer');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const progressWrapper = document.getElementById('progressWrapper');
        const progressBar = document.getElementById('progressBar');
        const currentTime = document.getElementById('currentTime');
        const totalTime = document.getElementById('totalTime');
        const initialMessage = document.getElementById('initialMessage');
        const volumeSlider = document.getElementById('volumeSlider');
        const toggleEqBtn = document.getElementById('toggleEqBtn');
        const changeBgBtn = document.getElementById('changeBgBtn');
        const bgModal = document.getElementById('bgModal');
        const bgGrid = document.getElementById('bgGrid');
        const closeBgModal = document.getElementById('closeBgModal');
        const bgUpload = document.getElementById('bgUpload');
        const togglePlaylistBtn = document.getElementById('togglePlaylistBtn');
        const modePlaylistBtn = document.getElementById('modePlaylistBtn');
        const modeRadioBtn = document.getElementById('modeRadioBtn');
        const addStationBtn = document.getElementById('addStationBtn');
        const stationsList = document.getElementById('stationsList');
        const stationModal = document.getElementById('stationModal');
        const stationModalTitle = document.getElementById('stationModalTitle');
        const stationName = document.getElementById('stationName');
        const stationGenre = document.getElementById('stationGenre');
        const stationUrl = document.getElementById('stationUrl');
        const testStationBtn = document.getElementById('testStationBtn');
        const cancelStationBtn = document.getElementById('cancelStationBtn');
        const saveStationBtn = document.getElementById('saveStationBtn');
        const radioStatus = document.getElementById('radioStatus');

        // State & Visualizer
        let playlist = [], radioStations = [], currentRadioIndex = -1, currentIndex = -1, isPlaying = false, db;
        let audioContext, analyser, sourceNode, dataArray;
        let animationFrameId = null;
        let equalizerEnabled = true;
        let colorThief;
        let currentMode = 'playlist';
        let editingStationIndex = -1;

        audioPlayer.volume = 0.75;
        
        // Updated radio stations with working URLs
        const defaultRadioStations = [
            { name: "Lofi Girl", genre: "Chill / Lofi Hip-Hop", streamUrl: "https://play.streamafrica.net/lofiradio" },
            { name: "Smooth Jazz", genre: "Jazz", streamUrl: "https://strm112.1.fm/smoothjazz_mobile_mp3" },
            { name: "Classic Rock", genre: "Rock", streamUrl: "https://strm112.1.fm/classicrock_mobile_mp3" },
            { name: "Chillhop", genre: "Chillhop", streamUrl: "https://stream.chillhop.com/rss" },
            { name: "Radio Paradise", genre: "Eclectic", streamUrl: "https://stream.radioparadise.com/rock-320" },
            { name: "DnB Radio", genre: "Drum & Bass", streamUrl: "https://streams.radiomast.io/4c4e45b8-3711-4eb5-b402-3ce5f9d2a855" }
        ];
        
        // --- LOGIC ---
        function setMode(mode) {
            currentMode = mode;
            localStorage.setItem('player_mode', mode);
            if (mode === 'playlist') {
                playlistContainer.classList.remove('hidden');
                radioContainer.classList.add('hidden');
                modePlaylistBtn.classList.add('accent-bg');
                modePlaylistBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                modeRadioBtn.classList.remove('accent-bg');
                modeRadioBtn.classList.add('bg-gray-700', 'hover:bg-gray-600');
            } else { // radio
                playlistContainer.classList.remove('hidden');
                radioContainer.classList.remove('hidden');
                modeRadioBtn.classList.add('accent-bg');
                modeRadioBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                modePlaylistBtn.classList.remove('accent-bg');
                modePlaylistBtn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                loadRadioStations();
            }
        }

        function loadRadioStations() {
            const savedStations = localStorage.getItem('radio_stations');
            radioStations = savedStations ? JSON.parse(savedStations) : defaultRadioStations;
            displayRadioStations();
        }

        function saveRadioStations() {
            localStorage.setItem('radio_stations', JSON.stringify(radioStations));
        }

        function displayRadioStations() {
            stationsList.innerHTML = '';
            radioStations.forEach((station, index) => {
                const stationEl = document.createElement('div');
                stationEl.className = 'station-item flex items-center justify-between p-3 rounded-xl bg-black/20 backdrop-blur-lg border border-white/5 hover:bg-black/40 cursor-pointer transition-colors duration-200 mb-2';
                stationEl.innerHTML = `
                    <div class="flex items-center flex-grow overflow-hidden mr-2 w-0 min-w-0">
                        <div class="w-12 h-12 rounded-md mr-4 bg-white/10 flex items-center justify-center flex-shrink-0">
                           <i class="fas fa-radio text-gray-300 text-xl"></i>
                        </div>
                        <div class="flex-grow overflow-hidden w-0 min-w-0">
                            <p class="font-semibold truncate">${station.name}</p>
                            <p class="text-sm text-gray-400 truncate">${station.genre}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="edit-station p-2 text-gray-400 hover:text-blue-400" data-index="${index}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-station p-2 text-gray-400 hover:text-red-400" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>`;
                
                stationEl.addEventListener('click', () => playRadioStation(index));
                
                stationEl.querySelector('.edit-station').addEventListener('click', (e) => {
                    e.stopPropagation();
                    editStation(index);
                });
                
                stationEl.querySelector('.delete-station').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteStation(index);
                });
                
                stationsList.appendChild(stationEl);
            });
            
            // Highlight currently playing station
            updateActiveTrackUI();
        }

        function addStation() {
            editingStationIndex = -1;
            stationModalTitle.textContent = "Add Radio Station";
            stationName.value = "";
            stationGenre.value = "";
            stationUrl.value = "";
            stationModal.classList.remove('hidden');
        }

        function editStation(index) {
            editingStationIndex = index;
            const station = radioStations[index];
            stationModalTitle.textContent = "Edit Radio Station";
            stationName.value = station.name;
            stationGenre.value = station.genre;
            stationUrl.value = station.streamUrl;
            stationModal.classList.remove('hidden');
        }

        function deleteStation(index) {
            if (confirm("Delete this station?")) {
                radioStations.splice(index, 1);
                saveRadioStations();
                displayRadioStations();
                
                if (currentRadioIndex === index) {
                    audioPlayer.pause();
                    setPlayingState(false);
                    currentRadioIndex = -1;
                    player.classList.add('translate-y-full');
                }
            }
        }

        function saveStation() {
            const name = stationName.value.trim();
            const genre = stationGenre.value.trim();
            const url = stationUrl.value.trim();
            
            if (!name || !url) {
                alert("Please enter station name and URL");
                return;
            }
            
            if (editingStationIndex >= 0) {
                // Update existing station
                radioStations[editingStationIndex] = { name, genre, streamUrl: url };
            } else {
                // Add new station
                radioStations.push({ name, genre, streamUrl: url });
            }
            
            saveRadioStations();
            displayRadioStations();
            stationModal.classList.add('hidden');
        }

        function testStation() {
            const url = stationUrl.value.trim();
            if (!url) {
                alert("Please enter a stream URL");
                return;
            }
            
            // Create a temporary audio element to test the stream
            const testAudio = new Audio();
            testAudio.src = url;
            
            testAudio.play().then(() => {
                alert("Stream is working!");
                testAudio.pause();
            }).catch(e => {
                alert("Error: Could not play stream. Please check the URL.");
                console.error("Stream test error:", e);
            });
        }
        
        function setRadioStatus(status) {
            radioStatus.className = 'radio-status';
            radioStatus.classList.remove('hidden');
            
            switch(status) {
                case 'buffering':
                    radioStatus.classList.add('status-buffering');
                    break;
                case 'playing':
                    radioStatus.classList.add('status-playing');
                    break;
                case 'error':
                    radioStatus.classList.add('status-error');
                    break;
                default:
                    radioStatus.classList.add('hidden');
            }
        }
        
        function playRadioStation(index) {
            if (index < 0 || index >= radioStations.length) return;
            
            // Stop current playback
            audioPlayer.pause();
            setPlayingState(false);
            
            audioPlayer.removeAttribute('crossOrigin');
            canvas.style.opacity = 0; 
            
            if (!audioContext) setupVisualizer();
            
            currentRadioIndex = index;
            const station = radioStations[index];
            
            // Show loading state
            currentTrackTitle.textContent = "Connecting...";
            currentTrackArtist.textContent = station.genre;
            currentTrackArt.src = "https://placehold.co/64x64/1f2937/4b5563?text=Radio";
            progressWrapper.classList.add('hidden');
            setRadioStatus('buffering');
            
            // Set audio source
            audioPlayer.src = station.streamUrl;
            
            // Attempt to play
            const playPromise = audioPlayer.play();
            
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        if (audioContext && audioContext.state === 'suspended') {
                            audioContext.resume();
                        }
                        setPlayingState(true);
                        player.classList.remove('translate-y-full');
                        currentTrackTitle.textContent = station.name;
                        setRadioStatus('playing');
                    })
                    .catch(e => {
                        console.error("Radio playback error:", e);
                        setPlayingState(false);
                        currentTrackTitle.textContent = "Error: Cannot play";
                        setRadioStatus('error');
                        
                        // Try alternative URL format if available
                        if (station.streamUrl.includes('http:')) {
                            const httpsUrl = station.streamUrl.replace('http:', 'https:');
                            setTimeout(() => {
                                audioPlayer.src = httpsUrl;
                                audioPlayer.play().catch(e => console.error("HTTPS fallback also failed:", e));
                            }, 1000);
                        }
                    });
            }
        }

        function playTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            audioPlayer.setAttribute('crossOrigin', 'anonymous');
            canvas.style.opacity = 1;
            setRadioStatus('');
            if (!audioContext) setupVisualizer();
            currentIndex = index;
            const trackInfo = playlist[currentIndex];
            db.transaction('tracks').objectStore('tracks').get(trackInfo.id).onsuccess = (event) => {
                const fullTrack = event.target.result;
                const audioURL = URL.createObjectURL(fullTrack.file);
                if (audioPlayer.src.startsWith('blob:')) URL.revokeObjectURL(audioPlayer.src);
                audioPlayer.src = audioURL;
                currentTrackTitle.textContent = trackInfo.fileName;
                currentTrackArtist.textContent = "Local File";
                currentTrackArt.src = "https://placehold.co/64x64/1f2937/4b5563?text=Music";
                progressWrapper.classList.remove('hidden');
                setTimeout(() => applyMarqueeIfNeeded(currentTrackTitle), 100);
                audioPlayer.play().then(() => {
                    if (audioContext.state === 'suspended') audioContext.resume();
                    setPlayingState(true);
                    player.classList.remove('translate-y-full');
                }).catch(e => console.error("Playback error:", e));
            };
        }

        function togglePlayPause() {
            if(currentMode === 'playlist') {
                if (currentIndex === -1 && playlist.length > 0) return playTrack(0);
                if (currentIndex === -1) return;
            } else {
                if (currentRadioIndex === -1 && radioStations.length > 0) return playRadioStation(0);
                if (currentRadioIndex === -1) return;
            }
            const action = isPlaying ? 'pause' : 'play';
            if (audioContext && audioContext.state === 'suspended') {
                 audioContext.resume().then(() => audioPlayer[action]());
            } else {
                audioPlayer[action]();
            }
        }
        function playNext() {
            if (currentMode === 'playlist') {
                playTrack((currentIndex + 1) % playlist.length || 0);
            } else {
                playRadioStation((currentRadioIndex + 1) % radioStations.length || 0);
            }
        }
        function playPrev() {
            if (currentMode === 'playlist') {
                playTrack((currentIndex - 1 + playlist.length) % playlist.length || 0);
            } else {
                playRadioStation((currentRadioIndex - 1 + radioStations.length) % radioStations.length || 0);
            }
        }
        
        // ... (other functions remain mostly the same, just replace builtInRadioStations with radioStations)

        // Initialize the application
        window.addEventListener('DOMContentLoaded', () => {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            colorThief = new ColorThief();
            initDB();
            loadSavedBackground();
            loadRadioStations();
            const savedMode = localStorage.getItem('player_mode') || 'playlist';
            setMode(savedMode);
        });
        
        // Add new event listeners for radio management
        addStationBtn.addEventListener('click', addStation);
        saveStationBtn.addEventListener('click', saveStation);
        cancelStationBtn.addEventListener('click', () => stationModal.classList.add('hidden'));
        testStationBtn.addEventListener('click', testStation);
        
        // ... (rest of the event listeners)

    </script>
</body>
</html>
